# TypeScript リファクタリング概要

## 目的
単一責任の原則（Single Responsibility Principle）に従って、大きなソースファイルを分割し、保守性と可読性を向上させる。

## 実施内容

### 変更前
- `src/synth.ts`: 699行 - すべての機能が1つのファイルに集約

### 変更後
以下の4つの新しいモジュールに責任を分離:

#### 1. `timing.ts` (23行)
**責任**: BPM/beatから再生周期を計算
- `calculateDuration(bpm, beat)`: 再生周期を秒単位で計算

#### 2. `ui-params.ts` (183行)
**責任**: UIパラメータの読み書きとマウストラッキング
- `readNumericParameter()`: DOM要素から数値パラメータを読み取り
- `readParametersFromUI()`: すべてのUIパラメータを読み込み
- `updateUIFields()`: 設定値でUIフィールドを更新
- `mapMouseToFilterParams()`: マウス位置をフィルタパラメータにマッピング
- `updateMousePositionDisplay()`: マウス位置表示を更新

#### 3. `audio-player.ts` (124行)
**責任**: Tone.jsを使用したオーディオ再生管理
- `loadTone()`: Tone.jsを動的にロード
- `isToneLoaded()`: ロード状態を確認
- `startAudioContext()`: AudioContextを開始
- `isAudioContextRunning()`: 実行状態を確認
- `playWavUrl()`: WAV URLからオーディオを再生
- `stopAndCleanup()`: 再生を停止してクリーンアップ

#### 4. `playback-mode.ts` (74行)
**責任**: 再生モード（WAV/Seq）管理
- `getCurrentMode()`: 現在のモードを取得
- `updateModeUI()`: タブUIを更新
- `switchMode()`: モードを切り替え

#### 5. `synth.ts` (497行) - リファクタリング後
**責任**: コーディネーター層
- 各モジュールを統合
- イベントハンドラーの配線
- アプリケーションのライフサイクル管理
- **202行削減（29%減）**

## テスト
すべての新しいモジュールに対応するテストを追加:
- `timing.test.ts`: 4テスト
- `ui-params.test.ts`: 7テスト
- 既存テスト: 35テスト

**合計**: 46テストすべて合格 ✓

## 利点

### 1. 単一責任の原則の遵守
各モジュールが1つの明確な責任を持つ

### 2. テスト容易性の向上
- 各モジュールを独立してテスト可能
- 純粋関数が多く、モック不要

### 3. コードの可読性向上
- ファイルサイズが小さく、理解しやすい
- モジュール名から責任が明確

### 4. 保守性の向上
- 変更の影響範囲が限定的
- 新機能追加が容易

### 5. 再利用性の向上
- 各モジュールが独立しており、他のプロジェクトでも使用可能

## アーキテクチャパターン
**レイヤードアーキテクチャ**を採用:
```
┌─────────────────────────┐
│   index.ts (Entry)      │
└───────────┬─────────────┘
            │
┌───────────▼─────────────┐
│   synth.ts              │  ← コーディネーター層
│   (Coordinator Layer)   │
└─┬──────┬────────┬───┬───┘
  │      │        │   │
  ▼      ▼        ▼   ▼
┌──────┬──────┬──────┬──────┐
│timing│ui-   │audio-│play- │  ← ドメインロジック層
│      │params│player│back- │
│      │      │      │mode  │
└──────┴──────┴──────┴──────┘
  │      │        │      │
  ▼      ▼        ▼      ▼
┌────────────────────────────┐
│   外部ライブラリ (Tone.js) │  ← 外部依存層
│   DOM API                  │
└────────────────────────────┘
```

## 今後の改善案
1. `synth.ts`の状態管理をさらに抽象化
2. イベントバスパターンの導入を検討
3. TypeScriptの厳格モードでの型安全性向上
