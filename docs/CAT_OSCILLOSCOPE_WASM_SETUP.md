# cat-oscilloscope Integration Setup

## Overview

wavlpf uses the [cat-oscilloscope](https://github.com/cat2151/cat-oscilloscope) library for waveform visualization. The library uses Rust/WASM for high-performance audio processing.

## ✅ Current Status

The cat-oscilloscope library is **successfully integrated and working**:
- Installed from GitHub repository using dist commit distribution
- WASM files automatically set up via postinstall script
- Waveform visualization is fully functional

For detailed usage information, see [OSCILLOSCOPE_USAGE.md](OSCILLOSCOPE_USAGE.md).

## WASM File Setup

The cat-oscilloscope library loads its WASM module dynamically at runtime from `{basePath}/wasm/wasm_processor.js`. To ensure these files are available in both development and production:

1. **Postinstall Script**: After `npm install`, the `scripts/setup-cat-oscilloscope-wasm.js` script automatically copies WASM files from `node_modules/cat-oscilloscope/dist/wasm/` to `public/wasm/`.

2. **Vite Public Directory**: Vite automatically serves files from `public/` during development and copies them to `dist/` during build.

3. **GitIgnore**: The `public/wasm/` directory is in `.gitignore` since it's generated automatically.

## Manual Setup (if needed)

If the postinstall script doesn't run automatically, you can manually copy the files:

```bash
npm run postinstall
# or manually:
mkdir -p public/wasm
cp node_modules/cat-oscilloscope/dist/wasm/* public/wasm/
```

## Troubleshooting

### Error: "Failed to update oscilloscope"

This error occurs when the WASM module cannot be loaded. Check:

1. **WASM files exist**: `ls public/wasm/wasm_processor.js`
2. **Files are served correctly**: 
   - Dev: `http://localhost:8080/wasm/wasm_processor.js` should be accessible
   - Prod: `https://cat2151.github.io/wavlpf/wasm/wasm_processor.js` should exist

### CI/CD Setup

In CI environments (like GitHub Actions), the postinstall script runs automatically after `npm ci` or `npm install`. No additional configuration needed.

## Technical Details

### Why This Setup?

1. **Dynamic Loading**: cat-oscilloscope loads WASM at runtime (not bundled by Vite)
2. **Base Path**: The library uses `determineBasePath()` to find the base URL and appends `/wasm/wasm_processor.js`
3. **GitHub Pages**: With `base: '/wavlpf/'` in vite.config.ts, files are served from `/wavlpf/wasm/`
4. **Dist Commit Distribution**: cat-oscilloscope uses dist commit distribution, meaning built files are committed to the repository, making GitHub installation seamless

### File Structure

```
public/wasm/           # Generated by postinstall (gitignored)
├── wasm_processor.js         # WASM loader
├── wasm_processor_bg.wasm    # Compiled WASM binary
├── wasm_processor.d.ts       # TypeScript definitions
├── wasm_processor_bg.wasm.d.ts
└── package.json

dist/wasm/            # Copied by Vite during build
└── (same files as public/wasm/)
```

## Related Documentation

- **[OSCILLOSCOPE_USAGE.md](OSCILLOSCOPE_USAGE.md)** - Complete usage guide
- [DEPLOYMENT_VERIFICATION.md](DEPLOYMENT_VERIFICATION.md) - Deployment verification

## Related Issues

- Issue #76, #78, #80: Initial discovery and resolution of WASM loading issues
- The current setup ensures WASM files are properly available at runtime
