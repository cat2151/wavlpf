# wavlpf

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/üáØüáµ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/üá∫üá∏-English-blue.svg" alt="English"></a>
  <a href="https://deepwiki.com/cat2151/wavlpf"><img src="https://deepwiki.com/badge.svg" alt="Ask DeepWiki"></a>
  <a href="https://cat2151.github.io/wavlpf/"><img src="https://img.shields.io/badge/üåê-Live_Demo-green.svg" alt="Live Demo"></a>
  <a href="https://github.com/cat2151/wavlpf/actions/workflows/ci.yml"><img src="https://img.shields.io/github/actions/workflow/status/cat2151/wavlpf/ci.yml?branch=main&label=CI" alt="CI Status"></a>
</p>

A simple software synthesizer with a Low-Pass Filter (LPF) implemented in Rust WASM.

## Demo

https://cat2151.github.io/wavlpf/

*This document is temporary and was quickly generated by an LLM. It will be revised in the future.*

## Features

-   **Rust WASM Signal Processor**: High-speed DSP processing implemented in Rust
    -   Millisecond-precision performance measurement
    -   Implemented as a Rust crate, usable from native environments
-   **220Hz Waveform Generator**: Sawtooth or pulse wave, with configurable duty cycle
-   **Biquad Filter**: Interactive filter controlled by mouse
    -   Multiple filter types: LPF, HPF, BPF, Notch, APF, Low Shelf, High Shelf
    -   X-axis: Cutoff frequency (20Hz - configurable max value)
    -   Y-axis: Resonance Q value (0.5 - configurable max value, inverted: Up = High, Down = Low)
    -   Configurable cutoff decay (Hz or Cent/millisecond)
-   **Waveform Visualization**: Real-time oscilloscope display using [cat-oscilloscope](https://github.com/cat2151/cat-oscilloscope)
    -   High-performance visualization with Rust/WASM
    -   Visualization of Float32Array buffers
    -   Loop playback support
-   **Non-Real-Time Rendering**: WebAudio-independent signal processing
-   **Configurable Audio Buffer**: BPM and beat-based audio generation timing
-   **WAV Generation**: Converts processed audio to WAV format
-   **Tone.js Integration**: Clean audio playback
-   **Settings Persistence**: Import/export settings with JSON files

## Related Documentation

### Oscilloscope Integration

**üìò Usage Guide** - [docs/OSCILLOSCOPE_USAGE.md](docs/OSCILLOSCOPE_USAGE.md) - **Current Implementation and Usage** (Japanese)

**Technical Details**:
- [docs/CAT_OSCILLOSCOPE_WASM_SETUP.md](docs/CAT_OSCILLOSCOPE_WASM_SETUP.md) - WASM Setup Details

### Development Guide

-   **[DEVELOPMENT.md](DEVELOPMENT.md)** - Development Framework and Testing Strategy

## Getting Started

For details on the development framework and testing strategy, refer to [DEVELOPMENT.md](DEVELOPMENT.md).

For waveform visualization, refer to [docs/OSCILLOSCOPE_USAGE.md](docs/OSCILLOSCOPE_USAGE.md).

### Prerequisites

-   Node.js (v14 or higher)
-   npm
-   Rust and wasm-pack (for building WASM modules)

#### Installing Rust and wasm-pack

**Method 1: Automated Installation Script (Recommended)**

Use the script provided in the project to install wasm-pack:

```bash
# Install wasm-pack
bash scripts/install-wasm-pack.sh
```

This script will:
-   Verify if Rust and cargo are installed
-   Check if wasm-pack is already installed
-   Install wasm-pack via cargo (works even in environments with network restrictions)
-   Confirm successful installation

**Method 2: Manual Installation**

Manually install Rust and wasm-pack:

```bash
# Install Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Install wasm-pack
cargo install wasm-pack
```

### Installation

```bash
npm install
```

### Development

Start a development server with Hot Module Replacement:

```bash
npm run dev
```

This will launch an instant HMR-enabled Vite development server. Your browser will automatically open at http://localhost:8080.

### Build

Build the WASM module and the entire application:

```bash
# Build WASM module only
npm run build:wasm

# Build everything (WASM + TypeScript + Vite production bundle)
npm run build
```

This performs TypeScript type checking, builds the Rust WASM module, and creates a production bundle with Vite.

**‚ö†Ô∏è Strict Warning about wasm-opt ‚ö†Ô∏è**:
-   Builds default to using `wasm-opt` (from binaryen) for WASM optimization
-   **This has been verified to work correctly in all environments, including CI**
-   **Setting `wasm-opt = false` in `wasm-audio/Cargo.toml` is strictly forbidden**
-   In the past, an AI agent mistakenly added `wasm-opt = false` twice based on baseless speculation
-   The owner's verification confirms that wasm-opt is enabled and works without issues
-   Do not alter the default setting (wasm-opt enabled)
-   Even if temporarily disabling it locally for debugging purposes, do not commit that change

### Preview Production Build

```bash
npm run preview
```

Inspect the production build locally before deployment.

### Testing

Run the test suite:

```bash
npm test         # Watch mode
npm run test:run # Run once
npm run test:ui  # Visual test runner
npm run coverage # Generate coverage report
```

### Run (Legacy)

Note: The `serve` command now uses Vite's preview server:

```bash
npm run serve
```

Then, open http://localhost:8080 in your browser (for development, please use `npm run dev`).

## Usage

1.  Open the application in your browser.
2.  Click anywhere on the page to start the audio context.
3.  **Configure Parameters**:
    -   Waveform Type: Sawtooth or Pulse wave
    -   Duty Cycle: For pulse wave (0-100%)
    -   BPM and Beat: Control audio generation timing
    -   Q Max Value: Maximum resonance value
    -   Cutoff Frequency Max Value: Maximum cutoff frequency
    -   Decay Unit: Hz or Cent
    -   Decay Rate: Decay rate per millisecond
4.  Move your mouse to control filter parameters in real-time:
    -   **Horizontal Position (X)**: Controls cutoff frequency (20Hz - max value)
    -   **Vertical Position (Y)**: Controls resonance/Q value (0.5 - max value, inverted: Up = High, Down = Low)
5.  Check the **Generation Time** display to monitor performance.
6.  Listen to new audio generated based on BPM and beat settings.

## Architecture

### Signal Processing (WebAudio Independent)

#### Rust WASM Implementation
-   `wasm-audio/src/lib.rs`: Complete signal processing pipeline in Rust
    -   Oscillator generation (sawtooth, pulse wave)
    -   Biquad LPF filter using RBJ Audio EQ Cookbook formulas
    -   Audio rendering including cutoff decay
-   `wasm-audio/pkg/`: Generated WASM bindings

#### Integration
-   `src/wasmAudio.ts`: TypeScript wrapper for the WASM module
    -   Dynamic WASM loading
    -   Performance measurement

### Application

-   `src/synth.ts`: Main synthesizer logic, including mouse tracking and audio playback
-   `src/wav.ts`: WAV file format generation
-   `src/settings.ts`: Settings persistence (localStorage and JSON import/export)
-   `src/index.ts`: Entry point
-   `index.html`: Web interface

## Deployment

The application is automatically deployed to GitHub Pages when changes are pushed to the `main` branch. The deployment workflow:

1.  Installs Node.js dependencies
2.  Builds TypeScript to JavaScript
3.  Copies necessary files from `index.html`, `dist/`, and `node_modules/` to the deployment directory
4.  Deploys to GitHub Pages

The workflow is defined in `.github/workflows/deploy.yml`.

## License

MIT