# wavlpf

A simple software synthesizer with a Low-Pass Filter (LPF) implemented in Rust WASM

## Demo

https://cat2151.github.io/wavlpf/

*Note: This document is provisional and was hastily generated by an LLM. It will be revised in the future.*

## Features

- **Rust WASM Signal Processor**: High-performance DSP processing implemented in Rust
  - Millisecond-precision performance measurement
  - Implemented as a Rust crate usable from native environments
- **220Hz Waveform Generator**: Sawtooth or pulse wave, with configurable duty cycle
- **Biquad Filter**: Interactive filter controlled by mouse
  - Multiple filter types: LPF, HPF, BPF, Notch, APF, Low Shelf, High Shelf
  - X-axis: Cutoff frequency (20Hz - configurable maximum)
  - Y-axis: Resonance Q value (0.5 - configurable maximum, inverted: up = high, down = low)
  - Configurable cutoff decay (Hz or Cent/millisecond)
- **Waveform Visualization**: Real-time oscilloscope display using [cat-oscilloscope](https://github.com/cat2151/cat-oscilloscope)
  - High-performance visualization with Rust/WASM
  - Float32Array buffer visualization
  - Supports loop playback
- **Non-Real-time Rendering**: WebAudio-independent signal processing
- **Configurable Audio Buffer**: BPM and beat-based audio generation timing
- **WAV Generation**: Converts processed audio to WAV format
- **Tone.js Integration**: Clean audio playback
- **Settings Persistence**: Import/export settings as JSON files

## Related Documentation

### Oscilloscope Integration

**üìò Usage Guide** - [docs/OSCILLOSCOPE_USAGE.md](docs/OSCILLOSCOPE_USAGE.md) - **Current implementation and usage** (Japanese)

**Technical Details**:
- [docs/CAT_OSCILLOSCOPE_WASM_SETUP.md](docs/CAT_OSCILLOSCOPE_WASM_SETUP.md) - WASM setup details

### Development Guide

- **[DEVELOPMENT.md](DEVELOPMENT.md)** - Development Framework and Testing Strategy

## Getting Started

For details on the development framework and testing strategy, please refer to [DEVELOPMENT.md](DEVELOPMENT.md).

For waveform visualization, please refer to [docs/OSCILLOSCOPE_USAGE.md](docs/OSCILLOSCOPE_USAGE.md).

### Prerequisites

- Node.js (v14 or higher)
- npm
- Rust and wasm-pack (for building WASM modules)

Installing Rust and wasm-pack:
```bash
# Install Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Install wasm-pack
cargo install wasm-pack
```

### Installation

```bash
npm install
```

### Development

Start a development server with Hot Module Replacement:

```bash
npm run dev
```

This will start an instant HMR-enabled Vite development server. Your browser will automatically open to http://localhost:8080.

### Building

Build the WASM module and the entire application:

```bash
# Build only the WASM module
npm run build:wasm

# Build everything (WASM + TypeScript + Vite production bundle)
npm run build
```

This performs TypeScript type checking, builds the Rust WASM module, and creates a production bundle with Vite.

**‚ö†Ô∏è Strict Warning Regarding wasm-opt ‚ö†Ô∏è**:
- Builds use `wasm-opt` (from binaryen) by default to optimize WASM.
- **This has been verified to work correctly in all environments, including CI.**
- **Setting `wasm-opt = false` in `wasm-audio/Cargo.toml` is strictly prohibited.**
- In the past, an AI agent incorrectly added `wasm-opt = false` twice based on unsubstantiated assumptions.
- The owner has verified that `wasm-opt` is effective and causes no issues.
- Do not change the default setting (wasm-opt enabled).
- Even if temporarily disabling it locally for debugging purposes, do not commit that change.

### Previewing Production Build

```bash
npm run preview
```

Verify the production build locally before deployment.

### Testing

Run the test suite:

```bash
npm test         # Watch mode
npm run test:run # Run once
npm run test:ui  # Visual test runner
npm run coverage # Generate coverage report
```

### Run (Legacy)

Note: The `serve` command now uses Vite's preview server:

```bash
npm run serve
```

Then, open http://localhost:8080 in your browser (use `npm run dev` for development).

## Usage

1. Open the application in your browser
2. Click anywhere on the page to start the audio context
3. **Configure Parameters**:
   - Waveform type: Sawtooth or pulse wave
   - Duty cycle: For pulse wave (0-100%)
   - BPM and Beats: Control audio generation timing
   - Q Max: Maximum resonance value
   - Cutoff Frequency Max: Maximum cutoff frequency
   - Decay Unit: Hz or Cent
   - Decay Rate: Decay rate per millisecond
4. Move your mouse to control filter parameters in real-time:
   - **Horizontal position (X)**: Controls cutoff frequency (20Hz - maximum value)
   - **Vertical position (Y)**: Controls resonance/Q value (0.5 - maximum value, inverted: up = high, down = low)
5. Monitor performance by checking the **Generation Time** display
6. Listen to new audio generated based on BPM and beat settings

## Architecture

### Signal Processing (WebAudio-Independent)

#### Rust WASM Implementation
- `wasm-audio/src/lib.rs`: Complete signal processing pipeline in Rust
  - Oscillator generation (sawtooth, pulse wave)
  - Biquad LPF filter using RBJ Audio EQ Cookbook formulas
  - Audio rendering including cutoff decay
- `wasm-audio/pkg/`: Generated WASM bindings

#### Integration
- `src/wasmAudio.ts`: TypeScript wrapper for the WASM module
  - Dynamic WASM loading
  - Performance measurement

### Application

- `src/synth.ts`: Main synthesizer logic, including mouse tracking and audio playback
- `src/wav.ts`: WAV file format generation
- `src/settings.ts`: Settings persistence (localStorage and JSON import/export)
- `src/index.ts`: Entry point
- `index.html`: Web interface

## Deployment

The application is automatically deployed to GitHub Pages when changes are pushed to the `main` branch. The deployment workflow:

1. Install Node.js dependencies
2. Build TypeScript to JavaScript
3. Copy necessary files from `index.html`, `dist/`, and `node_modules/` to the deployment directory
4. Deploy to GitHub Pages

The workflow is defined in `.github/workflows/deploy.yml`.

## License

MIT